<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Map Generator</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #1a1a1a;
                color: white;
                overflow: hidden;
            }

            .container {
                display: flex;
                height: 100vh;
            }

            .sidebar {
                width: 300px;
                background: #2a2a2a;
                border-right: 2px solid #444;
                overflow-y: auto;
                padding: 20px;
            }

            .sidebar h3 {
                color: #4caf50;
                margin-bottom: 15px;
                border-bottom: 2px solid #4caf50;
                padding-bottom: 5px;
            }

            .map-container {
                flex: 1;
                position: relative;
                background: #333;
                overflow: hidden;
            }

            .map-canvas {
                position: relative;
                width: 100%;
                height: 100%;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
            }

            .asset-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 10px;
                margin-bottom: 20px;
            }

            .asset-item,
            .background-item {
                width: 60px;
                height: 60px;
                border: 2px solid transparent;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s;
                background-size: cover;
                background-position: center;
            }

            .asset-item:hover,
            .background-item:hover {
                border-color: #4caf50;
                transform: scale(1.1);
            }

            .background-item.selected {
                border-color: #ff9800;
                box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
            }

            .placed-asset {
                position: absolute;
                cursor: move;
                border: 2px solid transparent;
                border-radius: 8px;
                transition: border-color 0.3s;
                background-size: cover;
                background-position: center;
                min-width: 50px;
                min-height: 50px;
            }

            .placed-asset.selected {
                border-color: #4caf50;
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            }

            .placed-asset.start {
                border-color: #ff9800;
                box-shadow: 0 0 15px rgba(255, 152, 0, 0.7);
            }

            .resize-handle {
                position: absolute;
                bottom: -5px;
                right: -5px;
                width: 15px;
                height: 15px;
                background: #4caf50;
                cursor: se-resize;
                border-radius: 50%;
            }

            .controls {
                margin-bottom: 20px;
            }

            .btn {
                background: #4caf50;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px 5px 5px 0;
                transition: background 0.3s;
            }

            .btn:hover {
                background: #45a049;
            }

            .btn.active {
                background: #ff9800;
            }

            .input-group {
                margin: 10px 0;
            }

            .input-group label {
                display: block;
                margin-bottom: 5px;
                color: #ccc;
            }

            .input-group input,
            .input-group textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #555;
                border-radius: 4px;
                background: #444;
                color: white;
            }

            .input-group textarea {
                height: 100px;
                resize: vertical;
            }

            .edge-line {
                position: absolute;
                height: 2px;
                background: #4caf50;
                transform-origin: left center;
                z-index: 1;
                pointer-events: none;
            }

            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
            }

            .modal-content {
                background-color: #2a2a2a;
                margin: 5% auto;
                padding: 20px;
                border-radius: 10px;
                width: 80%;
                max-width: 500px;
                border: 2px solid #4caf50;
            }

            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
            }

            .close:hover {
                color: white;
            }

            .file-input {
                display: none;
            }

            .prerequisites-list {
                max-height: 100px;
                overflow-y: auto;
                background: #444;
                border-radius: 4px;
                padding: 5px;
            }

            .prerequisite-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 2px 5px;
                margin: 2px 0;
                background: #555;
                border-radius: 3px;
            }

            .remove-prerequisite {
                background: #f44336;
                color: white;
                border: none;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                cursor: pointer;
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="sidebar">
                <div class="controls">
                    <h3>Map Settings</h3>
                    <div class="input-group">
                        <label>Map ID:</label>
                        <input
                            type="text"
                            id="mapId"
                            placeholder="Enter map ID"
                        />
                    </div>
                    <div class="input-group">
                        <label>Map Name:</label>
                        <input
                            type="text"
                            id="mapName"
                            placeholder="Enter map name"
                        />
                    </div>
                    <button class="btn" onclick="importMap()">
                        Import Map
                    </button>
                    <button class="btn" onclick="exportMap()">
                        Export Map
                    </button>
                    <input
                        type="file"
                        id="importFile"
                        class="file-input"
                        accept=".json"
                        onchange="handleImportFile(event)"
                    />
                </div>

                <div class="controls">
                    <h3>Tools</h3>
                    <button
                        class="btn"
                        id="selectTool"
                        onclick="setTool('select')"
                    >
                        Select
                    </button>
                    <button class="btn" id="edgeTool" onclick="setTool('edge')">
                        Add Edge
                    </button>
                    <button class="btn" onclick="clearSelection()">
                        Clear Selection
                    </button>
                    <button class="btn" onclick="deleteSelected()">
                        Delete Selected
                    </button>
                </div>

                <div>
                    <h3>Backgrounds</h3>
                    <div class="asset-grid" id="backgroundGrid">
                        <!-- Background images will be loaded here -->
                    </div>
                </div>

                <div>
                    <h3>Assets</h3>
                    <div class="asset-grid" id="assetGrid">
                        <!-- Asset images will be loaded here -->
                    </div>
                </div>

                <div id="assetProperties" style="display: none">
                    <h3>Asset Properties</h3>
                    <div class="input-group">
                        <label>Asset ID:</label>
                        <input
                            type="text"
                            id="assetId"
                            placeholder="Enter asset ID"
                        />
                    </div>
                    <div class="input-group">
                        <label>Asset Name:</label>
                        <input
                            type="text"
                            id="assetName"
                            placeholder="Enter asset name"
                        />
                    </div>
                    <div class="input-group">
                        <label>Prerequisites:</label>
                        <div
                            class="prerequisites-list"
                            id="prerequisitesList"
                        ></div>
                        <select id="prerequisiteSelect">
                            <option value="">Select prerequisite...</option>
                        </select>
                        <button class="btn" onclick="addPrerequisite()">
                            Add
                        </button>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="isStartAsset" /> Start
                            Asset
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="isRefuelAsset" /> Refuel
                            Asset
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="isTerminalAsset" />
                            Terminal Asset
                        </label>
                    </div>
                    <button class="btn" onclick="updateAssetProperties()">
                        Update
                    </button>
                </div>
            </div>

            <div class="map-container">
                <div class="map-canvas" id="mapCanvas">
                    <!-- Assets and edges will be placed here -->
                </div>
            </div>
        </div>

        <script>
            // Global state
            let currentTool = 'select';
            let selectedAsset = null;
            let selectedBackground = null;
            let isDragging = false;
            let isResizing = false;
            let dragOffset = { x: 0, y: 0 };
            let edgeStart = null;
            let mapData = {
                id: '',
                name: '',
                backgroundAsset: '',
                startIsland: '',
                islands: [],
                edges: [],
                refuelIslands: [],
                terminalIslands: [],
                islandPrerequisites: {},
            };

            // Dynamically discovered background images
            const availableBackgrounds = [
                'background1.jpg',
                'background2.jpg',
                'background3.jpg',
            ];

            // Dynamically discovered asset images
            const availableAssets = [
                'islands/island1.png',
                'islands/island1.svg',
                'islands/island2.png',
                'islands/island2.svg',
                'islands/island3.png',
                'islands/island3.svg',
                'islands/island4.png',
                'islands/island4.svg',
                'islands/island5.png',
                'islands/island5.svg',
                'islands/island6.png',
                'islands/island6.svg',
                'islands/island7.png',
                'islands/island7.svg',
                'islands/planet1.png',
                'islands/planet10.png',
                'islands/planet11.png',
                'islands/planet12.png',
                'islands/planet13.png',
                'islands/planet14.png',
                'islands/planet15.png',
                'islands/planet16.png',
                'islands/planet17.png',
                'islands/planet18.png',
                'islands/planet19.png',
                'islands/planet2.png',
                'islands/planet20.png',
                'islands/planet21.png',
                'islands/planet22.png',
                'islands/planet23.png',
                'islands/planet24.png',
                'islands/planet25.png',
                'islands/planet26.png',
                'islands/planet27.png',
                'islands/planet28.png',
                'islands/planet29.png',
                'islands/planet3.png',
                'islands/planet30.png',
                'islands/planet31.png',
                'islands/planet32.png',
                'islands/planet33.png',
                'islands/planet34.png',
                'islands/planet35.png',
                'islands/planet36.png',
                'islands/planet37.png',
                'islands/planet38.png',
                'islands/planet39.png',
                'islands/planet4.png',
                'islands/planet40.png',
                'islands/planet41.png',
                'islands/planet42.png',
                'islands/planet43.png',
                'islands/planet44.png',
                'islands/planet45.png',
                'islands/planet46.png',
                'islands/planet47.png',
                'islands/planet48.png',
                'islands/planet49.png',
                'islands/planet5.png',
                'islands/planet50.png',
                'islands/planet51.png',
                'islands/planet52.png',
                'islands/planet53.png',
                'islands/planet54.png',
                'islands/planet55.png',
                'islands/planet56.png',
                'islands/planet6.png',
                'islands/planet7.png',
                'islands/planet8.png',
                'islands/planet9.png',
            ];

            // Initialize the app
            function init() {
                loadBackgrounds();
                loadAssets();
                setupEventListeners();
                setTool('select');
            }

            function loadBackgrounds() {
                const grid = document.getElementById('backgroundGrid');
                availableBackgrounds.forEach((bg, index) => {
                    const item = document.createElement('div');
                    item.className = 'background-item';
                    item.style.backgroundImage = `url(${bg})`;
                    item.onclick = () => selectBackground(bg, item);
                    grid.appendChild(item);
                });
            }

            function loadAssets() {
                const grid = document.getElementById('assetGrid');
                availableAssets.forEach((asset, index) => {
                    const item = document.createElement('div');
                    item.className = 'asset-item';
                    item.style.backgroundImage = `url(${asset})`;
                    item.draggable = true;
                    item.ondragstart = e => startDragAsset(e, asset);
                    item.onclick = () => placeAsset(asset);
                    grid.appendChild(item);
                });
            }

            function selectBackground(bgPath, element) {
                // Remove previous selection
                document.querySelectorAll('.background-item').forEach(item => {
                    item.classList.remove('selected');
                });

                // Select new background
                element.classList.add('selected');
                selectedBackground = bgPath;
                mapData.backgroundAsset = bgPath.split('/').pop();

                // Apply background to canvas
                document.getElementById('mapCanvas').style.backgroundImage =
                    `url(${bgPath})`;
            }

            function startDragAsset(e, assetPath) {
                e.dataTransfer.setData('text/plain', assetPath);
            }

            function placeAsset(assetPath) {
                // Place at center of canvas for click placement
                const canvas = document.getElementById('mapCanvas');
                const rect = canvas.getBoundingClientRect();
                const x = rect.width / 2 - 50;
                const y = rect.height / 2 - 50;
                createAssetElement(assetPath, x, y);
            }

            function createAssetElement(assetPath, x, y, existingData = null) {
                const canvas = document.getElementById('mapCanvas');
                const asset = document.createElement('div');
                const assetId = existingData?.id || `asset_${Date.now()}`;

                asset.className = 'placed-asset';
                asset.style.backgroundImage = `url(${assetPath})`;
                asset.style.left = x + 'px';
                asset.style.top = y + 'px';
                asset.style.width =
                    (existingData?.width * canvas.offsetWidth || 80) + 'px';
                asset.style.height =
                    (existingData?.height * canvas.offsetHeight || 80) + 'px';
                asset.dataset.assetPath = assetPath;
                asset.dataset.assetId = assetId;

                // Add resize handle
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                asset.appendChild(resizeHandle);

                // Event listeners
                asset.onclick = e => {
                    e.stopPropagation();
                    if (currentTool === 'select') {
                        selectAsset(asset);
                    } else if (currentTool === 'edge') {
                        handleEdgeClick(asset);
                    }
                };

                canvas.appendChild(asset);

                // Add to map data if not loading from existing data
                if (!existingData) {
                    const rect = canvas.getBoundingClientRect();
                    const island = {
                        id: assetId,
                        name: `Asset ${mapData.islands.length + 1}`,
                        x: x / rect.width,
                        y: y / rect.height,
                        width: 80 / rect.width,
                        height: 80 / rect.height,
                        iconAsset: assetPath.split('/').pop(),
                    };
                    mapData.islands.push(island);
                }

                return asset;
            }

            function selectAsset(asset) {
                // Clear previous selection
                document.querySelectorAll('.placed-asset').forEach(a => {
                    a.classList.remove('selected');
                });

                asset.classList.add('selected');
                selectedAsset = asset;
                showAssetProperties(asset);
            }

            function showAssetProperties(asset) {
                const props = document.getElementById('assetProperties');
                const assetId = asset.dataset.assetId;
                const island = mapData.islands.find(i => i.id === assetId);

                if (island) {
                    document.getElementById('assetId').value = island.id;
                    document.getElementById('assetName').value = island.name;
                    document.getElementById('isStartAsset').checked =
                        mapData.startIsland === island.id;
                    document.getElementById('isRefuelAsset').checked =
                        mapData.refuelIslands.some(r => r.id === island.id);
                    document.getElementById('isTerminalAsset').checked =
                        mapData.terminalIslands.some(t => t.id === island.id);

                    updatePrerequisitesList(island.id);
                    updatePrerequisiteSelect();
                }

                props.style.display = 'block';
            }

            function updatePrerequisitesList(assetId) {
                const list = document.getElementById('prerequisitesList');
                const prerequisites =
                    mapData.islandPrerequisites[assetId] || [];

                list.innerHTML = '';
                prerequisites.forEach(prereqId => {
                    const item = document.createElement('div');
                    item.className = 'prerequisite-item';

                    const island = mapData.islands.find(i => i.id === prereqId);
                    const name = island ? island.name : prereqId;

                    item.innerHTML = `
                    <span>${name}</span>
                    <button class="remove-prerequisite" onclick="removePrerequisite('${assetId}', '${prereqId}')">×</button>
                `;
                    list.appendChild(item);
                });
            }

            function updatePrerequisiteSelect() {
                const select = document.getElementById('prerequisiteSelect');
                select.innerHTML =
                    '<option value="">Select prerequisite...</option>';

                mapData.islands.forEach(island => {
                    if (
                        selectedAsset &&
                        island.id !== selectedAsset.dataset.assetId
                    ) {
                        const option = document.createElement('option');
                        option.value = island.id;
                        option.textContent = island.name;
                        select.appendChild(option);
                    }
                });
            }

            function addPrerequisite() {
                const select = document.getElementById('prerequisiteSelect');
                const selectedPrereq = select.value;
                const currentAssetId = selectedAsset?.dataset.assetId;

                if (selectedPrereq && currentAssetId) {
                    if (!mapData.islandPrerequisites[currentAssetId]) {
                        mapData.islandPrerequisites[currentAssetId] = [];
                    }

                    if (
                        !mapData.islandPrerequisites[currentAssetId].includes(
                            selectedPrereq
                        )
                    ) {
                        mapData.islandPrerequisites[currentAssetId].push(
                            selectedPrereq
                        );
                        updatePrerequisitesList(currentAssetId);
                    }

                    select.value = '';
                }
            }

            function removePrerequisite(assetId, prereqId) {
                if (mapData.islandPrerequisites[assetId]) {
                    mapData.islandPrerequisites[assetId] =
                        mapData.islandPrerequisites[assetId].filter(
                            p => p !== prereqId
                        );
                    if (mapData.islandPrerequisites[assetId].length === 0) {
                        delete mapData.islandPrerequisites[assetId];
                    }
                    updatePrerequisitesList(assetId);
                }
            }

            function updateAssetProperties() {
                if (!selectedAsset) return;

                const assetId = selectedAsset.dataset.assetId;
                const island = mapData.islands.find(i => i.id === assetId);

                if (island) {
                    const newId = document.getElementById('assetId').value;
                    const newName = document.getElementById('assetName').value;

                    // Update island data
                    island.id = newId;
                    island.name = newName;
                    selectedAsset.dataset.assetId = newId;

                    // Handle start asset
                    if (document.getElementById('isStartAsset').checked) {
                        mapData.startIsland = newId;
                        document
                            .querySelectorAll('.placed-asset')
                            .forEach(a => a.classList.remove('start'));
                        selectedAsset.classList.add('start');
                    } else if (mapData.startIsland === newId) {
                        mapData.startIsland = '';
                        selectedAsset.classList.remove('start');
                    }

                    // Handle refuel islands
                    const refuelIndex = mapData.refuelIslands.findIndex(
                        r => r.id === assetId
                    );
                    if (document.getElementById('isRefuelAsset').checked) {
                        if (refuelIndex === -1) {
                            mapData.refuelIslands.push({ id: newId });
                        }
                    } else if (refuelIndex !== -1) {
                        mapData.refuelIslands.splice(refuelIndex, 1);
                    }

                    // Handle terminal islands
                    const terminalIndex = mapData.terminalIslands.findIndex(
                        t => t.id === assetId
                    );
                    if (document.getElementById('isTerminalAsset').checked) {
                        if (terminalIndex === -1) {
                            mapData.terminalIslands.push({ id: newId });
                        }
                    } else if (terminalIndex !== -1) {
                        mapData.terminalIslands.splice(terminalIndex, 1);
                    }

                    // Update prerequisites if ID changed
                    if (assetId !== newId) {
                        if (mapData.islandPrerequisites[assetId]) {
                            mapData.islandPrerequisites[newId] =
                                mapData.islandPrerequisites[assetId];
                            delete mapData.islandPrerequisites[assetId];
                        }

                        // Update references in other prerequisites
                        Object.keys(mapData.islandPrerequisites).forEach(
                            key => {
                                mapData.islandPrerequisites[key] =
                                    mapData.islandPrerequisites[key].map(p =>
                                        p === assetId ? newId : p
                                    );
                            }
                        );

                        // Update edges
                        mapData.edges.forEach(edge => {
                            if (edge.from === assetId) edge.from = newId;
                            if (edge.to === assetId) edge.to = newId;
                        });
                    }

                    updatePrerequisiteSelect();
                }
            }

            function handleEdgeClick(asset) {
                if (!edgeStart) {
                    edgeStart = asset;
                    asset.style.border = '3px solid #ff9800';
                } else if (edgeStart !== asset) {
                    createEdge(edgeStart, asset);
                    edgeStart.style.border = '2px solid transparent';
                    edgeStart = null;
                }
            }

            function createEdge(fromAsset, toAsset) {
                const fromId = fromAsset.dataset.assetId;
                const toId = toAsset.dataset.assetId;

                // Check if edge already exists
                const existingEdge = mapData.edges.find(
                    e =>
                        (e.from === fromId && e.to === toId) ||
                        (e.from === toId && e.to === fromId)
                );

                if (!existingEdge) {
                    mapData.edges.push({ from: fromId, to: toId });
                    drawEdge(fromAsset, toAsset);
                }
            }

            function drawEdge(fromAsset, toAsset) {
                const fromRect = fromAsset.getBoundingClientRect();
                const toRect = toAsset.getBoundingClientRect();
                const canvasRect = document
                    .getElementById('mapCanvas')
                    .getBoundingClientRect();

                const fromX =
                    fromRect.left - canvasRect.left + fromRect.width / 2;
                const fromY =
                    fromRect.top - canvasRect.top + fromRect.height / 2;
                const toX = toRect.left - canvasRect.left + toRect.width / 2;
                const toY = toRect.top - canvasRect.top + toRect.height / 2;

                const line = document.createElement('div');
                line.className = 'edge-line';
                line.dataset.from = fromAsset.dataset.assetId;
                line.dataset.to = toAsset.dataset.assetId;

                const length = Math.sqrt(
                    Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2)
                );
                const angle =
                    (Math.atan2(toY - fromY, toX - fromX) * 180) / Math.PI;

                line.style.left = fromX + 'px';
                line.style.top = fromY + 'px';
                line.style.width = length + 'px';
                line.style.transform = `rotate(${angle}deg)`;

                document.getElementById('mapCanvas').appendChild(line);
            }

            function redrawAllEdges() {
                // Remove existing edge lines
                document
                    .querySelectorAll('.edge-line')
                    .forEach(line => line.remove());

                // Redraw all edges
                mapData.edges.forEach(edge => {
                    const fromAsset = document.querySelector(
                        `[data-asset-id="${edge.from}"]`
                    );
                    const toAsset = document.querySelector(
                        `[data-asset-id="${edge.to}"]`
                    );
                    if (fromAsset && toAsset) {
                        drawEdge(fromAsset, toAsset);
                    }
                });
            }

            function setTool(tool) {
                currentTool = tool;
                document
                    .querySelectorAll('.btn')
                    .forEach(btn => btn.classList.remove('active'));
                document.getElementById(tool + 'Tool').classList.add('active');

                if (tool !== 'edge' && edgeStart) {
                    edgeStart.style.border = '2px solid transparent';
                    edgeStart = null;
                }
            }

            function clearSelection() {
                document
                    .querySelectorAll('.placed-asset')
                    .forEach(a => a.classList.remove('selected'));
                selectedAsset = null;
                document.getElementById('assetProperties').style.display =
                    'none';
            }

            function deleteSelected() {
                if (!selectedAsset) return;

                const assetId = selectedAsset.dataset.assetId;

                // Remove from islands array
                mapData.islands = mapData.islands.filter(i => i.id !== assetId);

                // Remove from edges
                mapData.edges = mapData.edges.filter(
                    e => e.from !== assetId && e.to !== assetId
                );

                // Remove from special arrays
                mapData.refuelIslands = mapData.refuelIslands.filter(
                    r => r.id !== assetId
                );
                mapData.terminalIslands = mapData.terminalIslands.filter(
                    t => t.id !== assetId
                );

                // Remove from prerequisites
                delete mapData.islandPrerequisites[assetId];
                Object.keys(mapData.islandPrerequisites).forEach(key => {
                    mapData.islandPrerequisites[key] =
                        mapData.islandPrerequisites[key].filter(
                            p => p !== assetId
                        );
                    if (mapData.islandPrerequisites[key].length === 0) {
                        delete mapData.islandPrerequisites[key];
                    }
                });

                // Remove start island if it's the deleted asset
                if (mapData.startIsland === assetId) {
                    mapData.startIsland = '';
                }

                // Remove from DOM
                selectedAsset.remove();
                selectedAsset = null;
                document.getElementById('assetProperties').style.display =
                    'none';

                // Redraw edges
                redrawAllEdges();
            }

            function importMap() {
                document.getElementById('importFile').click();
            }

            function handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadMapData(data);
                    } catch (error) {
                        alert('Error loading map file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            function loadMapData(data) {
                // Clear current map
                document.getElementById('mapCanvas').innerHTML = '';

                // Load map data
                mapData = data;
                document.getElementById('mapId').value = data.id || '';
                document.getElementById('mapName').value = data.name || '';

                // Set background
                if (data.backgroundAsset) {
                    const bgPath = `backgrounds/${data.backgroundAsset}`;
                    document.getElementById('mapCanvas').style.backgroundImage =
                        `url(${bgPath})`;
                }

                // Load islands
                const canvas = document.getElementById('mapCanvas');
                const rect = canvas.getBoundingClientRect();

                data.islands.forEach(island => {
                    const x = island.x * rect.width;
                    const y = island.y * rect.height;
                    const assetPath = `islands/${island.iconAsset}`;

                    const asset = createAssetElement(assetPath, x, y, island);

                    // Mark start asset
                    if (data.startIsland === island.id) {
                        asset.classList.add('start');
                    }
                });

                // Draw edges after all assets are created
                setTimeout(() => {
                    redrawAllEdges();
                }, 100);
            }

            function exportMap() {
                // Update map basic info
                mapData.id = document.getElementById('mapId').value;
                mapData.name = document.getElementById('mapName').value;

                // Update asset positions and sizes
                const canvas = document.getElementById('mapCanvas');
                const rect = canvas.getBoundingClientRect();

                document.querySelectorAll('.placed-asset').forEach(asset => {
                    const assetId = asset.dataset.assetId;
                    const island = mapData.islands.find(i => i.id === assetId);

                    if (island) {
                        const assetRect = asset.getBoundingClientRect();
                        island.x = (assetRect.left - rect.left) / rect.width;
                        island.y = (assetRect.top - rect.top) / rect.height;
                        island.width = assetRect.width / rect.width;
                        island.height = assetRect.height / rect.height;
                    }
                });

                // Create download
                const dataStr = JSON.stringify(mapData, null, 2);
                const dataBlob = new Blob([dataStr], {
                    type: 'application/json',
                });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${mapData.id || 'map'}.json`;
                link.click();

                URL.revokeObjectURL(url);
            }

            async function refreshImages() {
                // Clear existing grids
                document.getElementById('backgroundGrid').innerHTML = '';
                document.getElementById('assetGrid').innerHTML = '';

                // Reload images
                await loadBackgrounds();
                await loadAssets();
            }

            function setupEventListeners() {
                const canvas = document.getElementById('mapCanvas');

                // Canvas click for deselection
                canvas.onclick = e => {
                    if (e.target === canvas) {
                        clearSelection();
                        if (edgeStart) {
                            edgeStart.style.border = '2px solid transparent';
                            edgeStart = null;
                        }
                    }
                };

                // Drag and drop
                canvas.ondragover = e => e.preventDefault();
                canvas.ondrop = e => {
                    e.preventDefault();
                    const assetPath = e.dataTransfer.getData('text/plain');
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - 40;
                    const y = e.clientY - rect.top - 40;
                    createAssetElement(assetPath, x, y);
                };

                // Mouse events for dragging and resizing
                let startX,
                    startY,
                    startLeft,
                    startTop,
                    startWidth,
                    startHeight;

                canvas.onmousedown = e => {
                    const target = e.target;

                    if (target.classList.contains('resize-handle')) {
                        e.preventDefault();
                        isResizing = true;
                        const asset = target.parentElement;
                        const rect = asset.getBoundingClientRect();
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = rect.width;
                        startHeight = rect.height;

                        const mouseMoveResize = e => {
                            if (!isResizing) return;

                            const newWidth = Math.max(
                                50,
                                startWidth + (e.clientX - startX)
                            );
                            const newHeight =
                                (startHeight / startWidth) * newWidth;

                            asset.style.width = newWidth + 'px';
                            asset.style.height = newHeight + 'px';

                            redrawAllEdges();
                        };

                        const mouseUpResize = () => {
                            isResizing = false;
                            document.removeEventListener(
                                'mousemove',
                                mouseMoveResize
                            );
                            document.removeEventListener(
                                'mouseup',
                                mouseUpResize
                            );
                        };

                        document.addEventListener('mousemove', mouseMoveResize);
                        document.addEventListener('mouseup', mouseUpResize);
                    } else if (
                        target.classList.contains('placed-asset') &&
                        currentTool === 'select'
                    ) {
                        e.preventDefault();
                        isDragging = true;
                        const rect = target.getBoundingClientRect();
                        const canvasRect = canvas.getBoundingClientRect();

                        dragOffset.x = e.clientX - rect.left;
                        dragOffset.y = e.clientY - rect.top;

                        const mouseMoveAug = e => {
                            if (!isDragging) return;

                            const newX =
                                e.clientX - canvasRect.left - dragOffset.x;
                            const newY =
                                e.clientY - canvasRect.top - dragOffset.y;

                            target.style.left =
                                Math.max(
                                    0,
                                    Math.min(
                                        newX,
                                        canvasRect.width - target.offsetWidth
                                    )
                                ) + 'px';
                            target.style.top =
                                Math.max(
                                    0,
                                    Math.min(
                                        newY,
                                        canvasRect.height - target.offsetHeight
                                    )
                                ) + 'px';

                            redrawAllEdges();
                        };

                        const mouseUpDrag = () => {
                            isDragging = false;
                            document.removeEventListener(
                                'mousemove',
                                mouseMoveAug
                            );
                            document.removeEventListener(
                                'mouseup',
                                mouseUpDrag
                            );
                        };

                        document.addEventListener('mousemove', mouseMoveAug);
                        document.addEventListener('mouseup', mouseUpDrag);
                    }
                };

                // Keyboard shortcuts
                document.onkeydown = e => {
                    if (e.key === 'Delete' && selectedAsset) {
                        deleteSelected();
                    } else if (e.key === 'Escape') {
                        clearSelection();
                        setTool('select');
                    } else if (e.ctrlKey || e.metaKey) {
                        if (e.key === 's') {
                            e.preventDefault();
                            exportMap();
                        } else if (e.key === 'o') {
                            e.preventDefault();
                            importMap();
                        }
                    }
                };
            }

            // Initialize the application
            window.onload = init;
        </script>
    </body>
</html>
